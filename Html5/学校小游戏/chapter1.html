<html>

<head>
    <script src="E:\Tools\Scripts\jquery-3.4.1\jquery-3.4.1.min.js"></script>
    <script src="E:\Tools\Scripts\underscore\underscore_1.9.1.js"></script>
    <style type="text/css">
        .wrap {
            position: relative;
            width: 1000px;
            height: 1000px;
            border-style: solid;
            border-width: 1px;
        }

        .info {
            position: absolute;
            width: 500px;
            height: 300px;
            left: 1100px;
            top: 10px;
            border-style: solid;
            border-width: 1px;
        }

        .answer {
            position: relative;
            top: 10px;
            width: 1000px;
            height: 100px;
            border-style: solid;
            border-width: 1px;
        }

        .block {
            position: absolute;
            width: 25px;
            height: 25px;
            border-style: dotted;
            border-width: 1px;
        }

        li {
            display: inline;
        }

        button {
            width: 90px;
            height: 40px;
            background-color: coral;
            border-radius: 25px;
        }
    </style>

    <script type="text/javascript">
        $(function () {
            var $warp = $(".wrap");
            var w = 25;
            var h = 25;
            var storedBlocks = [];
            //随机产生1~10连载一起的块
            function generateBlocks() {
                var blocks = [];
                //生成格子的数目（1~10个之间）
                var blocknumber = Math.floor((Math.random() * 10) + 1);

                $("#blocknumber").val(blocknumber);

                //从0~39动态生成第一个格子
                var firstblock = { x: Math.floor(Math.random() * 29 + 10), y: Math.floor(Math.random() * 3) };

                blocks.push(firstblock);

                var i = 0;

                while (blocks.length < blocknumber & i++ < 100) {
                    //下一个相邻格子
                    var nextblockseed = Math.floor(Math.random() * (blocks.length * 100 - 1));

                    var seedblock = blocks[Math.floor(nextblockseed / 100)];

                    //随机决定是向该格子的上下左右方向生成下一个格子1234代表上下左右
                    var way = Math.floor((Math.random() * 4) + 1);

                    var nextblock = null;

                    switch (way) {
                        case 1:
                            //顶层边界不生成格子
                            if (seedblock.y === 0) {
                                break;
                            }

                            nextblock = { x: seedblock.x, y: seedblock.y - 1 };
                            break;
                        case 2:
                            //底层边界不生成格子
                            if (seedblock.y === 39) {
                                break;
                            }

                            nextblock = { x: seedblock.x, y: seedblock.y + 1 };
                            break;
                        case 3:
                            //最左边界不生成格子
                            if (seedblock.x === 0) {
                                break;
                            }

                            nextblock = { x: seedblock.x - 1, y: seedblock.y };
                            break;
                        case 4:
                            //最左边界不生成格子
                            if (seedblock.x === 39) {
                                break;
                            }

                            nextblock = { x: seedblock.x - 1, y: seedblock.y };
                            break;
                        default:
                            break;
                    }

                    if (nextblock != null && _.find(blocks, function (e) { return e.x === nextblock.x && e.y === nextblock.y }) === undefined) {
                        blocks.push(nextblock);
                    }
                }

                return blocks;
            }

            function start() {
                //1.随机生成格子
                var blocks = generateBlocks();

                //2.以一定间隔下降格子
                var ref = setInterval(function () {

                    //判断是否触底或者底部已有堆积块
                    if (checkToBottom(blocks) || checkHasBlock(blocks)) {
                        window.clearTimeout(ref);

                        for (var i = 0; i < blocks.length; i++) {
                            storedBlocks.push(blocks[i]);
                        }

                        return;
                    }
                    $(".blocks").empty();

                    //清除上一个格子的颜色
                    for (var i = 0; i < blocks.length; i++) {
                        var block = blocks[i];

                        var $block = $(".block" + pad(block.x, 2) + "" + pad(block.y, 2));

                        $block.css("background-color", "");

                        //所有格子下降一格
                        block.y++;
                    }

                    //清除上一个格子的颜色
                    for (var i = 0; i < blocks.length; i++) {
                        var block = blocks[i];

                        var $block = $(".block" + pad(block.x, 2) + "" + pad(block.y, 2));

                        $block.css("background-color", "red");

                        $(".blocks").append("<div>x:" + block.x + ";y:" + block.y + ";</div>")
                    }


                }, 50);
            }

            function checkToBottom(blocks) {
                for (var i = 0; i < blocks.length; i++) {
                    var block = blocks[i];

                    if (block.y >= 39) {
                        return true;
                    }
                }

                return false;
            }

            function checkHasBlock(blocks) {
                var bottomestItems = [];

                for (var i = 0; i < blocks.length; i++) {
                    var block = blocks[i];
                    var bottomitem = _.find(bottomestItems, function (e) { return e.x === block.x });

                    if (bottomitem !== undefined) {
                        if (block.y > bottomitem.y) {

                            _.map(bottomestItems, function (e) { return e.x !== block.x });
                        }
                    }

                    bottomestItems.push(block);
                }

                for (var i = 0; i < bottomestItems.length; i++) {
                    var block = blocks[i];

                    if (_.find(storedBlocks, function (e) { return e.x === block.x && e.y === block.y + 1 }) !== undefined) {
                        return true;
                    }
                }

                return false;
            }

            function init() {

                //  加载格子
                for (var i = 0; i < 40; i++) {

                    for (var j = 0; j < 40; j++) {
                        var blockdiv = $("<div class='block block" + pad(i, 2) + "" + pad(j, 2) + "' style='left:" + i * w + "px;top:" + j * h + "px;'></div>");
                        $warp.append(blockdiv);
                    }
                }

                $("#start").on("click", function () {
                    start();
                });
            }

            /* 神奇递归法 */
            function pad(num, n) {
                if ((num + "").length >= n) return num;
                return pad("0" + num, n);
            }

            init();


        });
    </script>
</head>

<body>
    <div class="wrap">

    </div>

    <div class="info">
        <div>
            <span>
                <label for="block-nulber">格子的数量:</label>
            </span>
            <input type="text" id="blocknumber" disabled>
            <button id="start">开始</button>
        </div>
        <div><span>
                <label for="block-nulber">x:</label>
            </span>
            <input type="text" id="x" disabled>
        </div>
        <div><span>
                <label for="block-nulber">y:</label>
            </span>
            <input type="text" id="y" disabled>
        </div>
        <div class="blocks"></div>
    </div>

    <div class="answer">
        <ul>
            <li><button value="1">1</button></li>
            <li><button value="2">2</button></li>
            <li><button value="3">3</button></li>
            <li><button value="4">4</button></li>
            <li><button value="5">5</button></li>
            <li><button value="6">6</button></li>
            <li><button value="7">7</button></li>
            <li><button value="8">8</button></li>
            <li><button value="9">9</button></li>
            <li><button value="10">10</button></li>
        </ul>
    </div>
</body>

</html>